# Blue-Green (Canary) развёртывание через Application Load Balancer

Частый сценарий, что у нашего приложения появилась новая версия, и хочется её постепенно сделать доступной
пользователям, отслеживая нежелательные показатели, например появление кодов серверных ошибок в HTTP ответах или
значительно увеличение задержки ответа.

Эту задачу можно решить так:
* Развернуть новую версию приложения
* На ALB перенаправить не неё небольшую часть запросов
* По мониторингам ALB проследить отсутствие негативных эффектов
* В случае успеха перенаправить большую часть трафика
* А в случае возникновения проблем
    * Вернуть трафик обратно
    * Исправить приложение и выложить его снова
    * Попробовать всё заново
* Дойдя до полного перенаправления трафика свернуть старую версию приложения

За данной техникой устоялось имя Blue-Green, или Сине-Зелёный деплоймент, где цветом называют версию приложения.

Проделаем это с нашим приложением `clock`.

## Разделим приложение на Blue-Green

Для Blue-Green нам удобно будет использовать текущее определение сервиса как "базу", и отдельно иметь две простых "
шаблонизации", которые выставят в суффикс имени и отельную метку цвет деплоймента, и позволят переопределить число
реплик и образ приложения.

В `kubectl` для этого встроен
механизм [kustomization](https://kubernetes.io/docs/tasks/manage-kubernetes-objects/kustomization/). Если коротко, то в
файле `kustomization.yaml` можно определить, на чём базируется кастомизация, и что в ней нужно поменять.

Используя этот инструмент, текущие файлы переместим в `deploy/clock/base`, и определим кастомизации:
* `deploy/clock/green` с текущей версией
* `deploy/clock/blue` в которой будем разворачивать новую, пока без подов
* `deploy/clock` которая, для удобства, объединит Blue и Green

Запустим скрипт, который проделает нужное:
```bash
./steps/7_blue_green_balancing/kustomize_clock_blue_green.sh
```

Рассмотрим получившуюся `green` кастомизацию:
```base 
cat deploy/clock/green/kustomization.yaml
```
Видно что она:
* Добавляет суффикс `green` к имени
* Добавляет метку `colour: green` объектам и селекторам

Посмотрим как будет выглядеть результат кастомизации:
```bash
kubectl kustomize deploy/clock/green
```

Отлично, теперь рассмотрим `blue` кастомизацию:
```base 
tail -n +1 deploy/clock/blue/*
```
Видно, что она отличается от `green` суффиксом и меткой, но, кроме этого, число реплик в ней 0:
```bash 
kubectl kustomize deploy/clock/blue | grep replicas -B 8
```

В корневой кастомизации Blue и Green объединены:
```bash
cat deploy/clock/kustomization.yaml
```

Что позволяет их применять одной командой. Что и сделаем:
```bash
kubectl apply -k deploy/clock
kubectl rollout status deployment/clock-green
```

Новые деплойменты попадает под селектор базового сервиса, поэтому в его эндпоинтах будут и зелёные и базовые поды:
```bash
kubectl get endpoints clock -o json | jq '.subsets[].addresses[].targetRef.name' -r | sort
```

Важно пока оставить базовый сервис, т.к. на него настроена маршрутизация в Ingress. Но базовый деплоймент уже можно
удалить, т.к. зелёный ему эквивалентен:
```bash 
kubectl delete deployment clock
```

Убедимся что мы ничего не сломали. Подождём пока останутся только зелёные поды и отмените ожидание нажав `Ctrl+C`, когда
это произойдёт:
```base
watch kubectl get pod -l app=clock
```

Убедимся, что `clock` сервис продолжает корректно работать через ALB.
```bash
curl http://scale-2021-k8s-workshop.yandex.cloud/clock
```

## Настроим Blue-Green балансировку

Yandex Cloud ALB Ingress контроллер принимает расширенные настройки балансировки путём использования специального
ресурса
`HttpBackendGroup` в котором можно указать, в том числе, веса для бекенда. Создадим такой ресурс для наших Blue-Green
сервисов, и перенаправим маршрут Ingress на него, вызвав:
```bash
./steps/7_blue_green_balancing/make_clock_ingress_blue_green.sh
```

Посмотрим результат:
```bash
cat ./deploy/clock_backend_group.yaml
kubectl diff -f ./deploy/ingress.yaml
```

Применим его:
```bash
kubectl apply -f ./deploy
```

Снова откроем карту балансировки в Web UI:
```bash
./steps/6_publish_apps_using_application_load_balancer/alb_web_ui_link.sh
```

Будет видно, что  `/clock` префикс балансируется на группу из двух бекендов, один с весом 100, другой с 0, как мы и
описали в `HttpBackendGroup`.

Стоит учесть, что может потребоваться до минуты, чтобы новые правила балансировки применились на ALB юнитах.


